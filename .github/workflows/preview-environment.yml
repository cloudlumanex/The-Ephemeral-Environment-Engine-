name: Preview Environment Manager

permissions:
  contents: read
  packages: write
  pull-requests: write

on:
  pull_request:
    types: [opened, synchronize, reopened, closed]

jobs:
  provision:
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Extract PR info
        id: pr_info
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV
          echo "BRANCH_NAME=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV
          echo "PR_AUTHOR=${{ github.event.pull_request.user.login }}" >> $GITHUB_ENV

      - name: Generate environment name
        id: env_name
        run: |
          ENV_NAME="pr-${{ env.PR_NUMBER }}"
          echo "env_name=${ENV_NAME}" >> $GITHUB_OUTPUT
          echo "Environment: $ENV_NAME"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: ./demo-app
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/ephemeral-demo:pr-${{ env.PR_NUMBER }}
            ghcr.io/${{ github.repository_owner }}/ephemeral-demo:${{ github.sha }}
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/ephemeral-demo:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/ephemeral-demo:buildcache,mode=max
      
      - name: Image built successfully
        run: |
          echo "âœ… Docker image built and pushed!"
          echo "Image: ghcr.io/${{ github.repository_owner }}/ephemeral-demo:pr-${{ env.PR_NUMBER }}"

      # Install Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.13.4
      
      # Provision Infrastructure with Terraform
      - name: Provision Infrastructure
        working-directory: ./terraform/environments/dev
        env:
          KUBE_CONFIG_PATH: ${{ github.workspace }}/.kube/config
        run: |
          # Create kubeconfig (for now, this will be a placeholder for kind)
          # In production, you'd configure kubectl to connect to your cluster
          echo "Setting up Kubernetes access..."
          mkdir -p $HOME/.kube
          # TODO: Configure kubectl for your cluster
          
          # Initialize Terraform
          terraform init
          
          # Create terraform.tfvars
          cat > terraform.tfvars << EOF
          pr_number        = "${{ env.PR_NUMBER }}"
          environment_name = "pr-${{ env.PR_NUMBER }}"
          namespace        = "pr-${{ env.PR_NUMBER }}"
          db_password      = "${{ secrets.DB_PASSWORD }}"
          EOF
          
          # Apply Terraform
          terraform apply -auto-approve
          
          # Save outputs for next steps
          echo "DB_URL=$(terraform output -raw db_connection_string)" >> $GITHUB_ENV
      
      # Deploy Application to Kubernetes
      - name: Deploy Application
        working-directory: ./k8s
        env:
          PR_NUMBER: ${{ env.PR_NUMBER }}
          NAMESPACE: pr-${{ env.PR_NUMBER }}
          IMAGE: ghcr.io/${{ github.repository_owner }}/ephemeral-demo:pr-${{ env.PR_NUMBER }}
          ENV_NAME: pr-${{ env.PR_NUMBER }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}
          DB_URL: ${{ env.DB_URL }}
        run: |
          chmod +x deploy.sh
          ./deploy.sh
      
      # Comment on PR with deployment info
      - name: Comment deployment status
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ env.PR_NUMBER }};
            const envName = `pr-${prNumber}`;
            const imageTag = `ghcr.io/${{ github.repository_owner }}/ephemeral-demo:pr-${prNumber}`;
            
            const body = `## ğŸš€ Preview Environment Deployed!
            
            **Environment:** \`${envName}\`
            **Docker Image:** \`${imageTag}\`
            **Namespace:** \`${envName}\`
            **Database:** PostgreSQL (isolated instance)
            
            ### Resources Created:
            - âœ… Kubernetes Namespace
            - âœ… PostgreSQL Database
            - âœ… Application Deployment
            - âœ… Service (ClusterIP)
            
            ### Access:
            To access locally:
            \`\`\`bash
            kubectl port-forward -n ${envName} svc/demo-app 8080:80
            curl http://localhost:8080/
            \`\`\`
            
            This environment will be automatically destroyed when the PR is closed.`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          
      - name: Echo PR details
        run: |
          echo "Creating preview for PR #$PR_NUMBER"
          echo "Branch: $BRANCH_NAME"
          echo "Author: $PR_AUTHOR"
      
      # We'll add more steps here later (Terraform, K8s deploy, etc.)

  teardown:
    if: github.event.action == 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Extract PR info
        run: |
          echo "PR_NUMBER=${{ github.event.pull_request.number }}" >> $GITHUB_ENV

      - name: Generate environment name
        id: env_name
        run: |
          ENV_NAME="pr-${{ env.PR_NUMBER }}"
          echo "env_name=${ENV_NAME}" >> $GITHUB_OUTPUT
          echo "Environment: $ENV_NAME"

      # Setup Terraform for teardown
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.13.4
      
      # Destroy Infrastructure
      - name: Destroy Infrastructure
        working-directory: ./terraform/environments/dev
        run: |
          # Initialize Terraform
          terraform init
          
          # Create terraform.tfvars for destroy
          cat > terraform.tfvars << EOF
          pr_number        = "${{ env.PR_NUMBER }}"
          environment_name = "pr-${{ env.PR_NUMBER }}"
          namespace        = "pr-${{ env.PR_NUMBER }}"
          db_password      = "dummy-for-destroy"
          EOF
          
          # Destroy resources
          terraform destroy -auto-approve
      
      # Comment on PR
      - name: Comment cleanup status
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const envName = `pr-${{ env.PR_NUMBER }}`;
            
            const body = `## ğŸ§¹ Preview Environment Destroyed
            
            **Environment:** \`${envName}\`
            
            All resources have been cleaned up:
            - âœ… Kubernetes namespace deleted
            - âœ… PostgreSQL database removed
            - âœ… Application deployment removed
            
            Thank you for your contribution!`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
          
      - name: Echo teardown
        run: |
          echo "Tearing down preview for PR #$PR_NUMBER"
      
      # We'll add cleanup steps here later
